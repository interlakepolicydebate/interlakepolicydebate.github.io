<!DOCTYPE html>
<html>
<head>
  <meta charset="UTF-8" />
  <title>ðŸ¦ˆ</title>
  <style>
    :root {
      --bg: #f7faf8;
      --card: #ffffff;
      --accent: #7ea7a6;
      --accent-soft: #e8f1ef;
      --text: #2f3640;
      --muted: #6b7683;
      --border: #e3e7ea;
    }

    * {
      box-sizing: border-box;
    }

    body {
      font-family: "Inter", "Segoe UI", system-ui, -apple-system, sans-serif;
      margin: 0;
      padding: 32px;
      background: var(--bg);
      color: var(--text);
    }

    .shell {
      max-width: 960px;
      margin: 0 auto;
      background: var(--card);
      padding: 28px 32px 36px;
      border: 1px solid var(--border);
      border-radius: 0;
      box-shadow: none;
    }

    h1 {
      font-size: 26px;
      margin: 0 0 18px;
      letter-spacing: 0.2px;
    }

    .controls {
      display: flex;
      gap: 8px;
      align-items: center;
      flex-wrap: wrap;
      margin-bottom: 6px;
      row-gap: 10px;
    }

    .controls.actions {
      margin-top: 10px;
      justify-content: flex-start;
    }

    input[type="text"] {
      padding: 10px 12px;
      width: min(420px, 100%);
      font-size: 16px;
      border-radius: 0;
      border: 1px solid var(--border);
      background: #fdfefe;
      color: var(--text);
      transition: border-color 0.15s ease, box-shadow 0.15s ease;
    }

    select {
      padding: 10px 12px;
      font-size: 14px;
      border: 1px solid var(--border);
      background: #fdfefe;
      color: var(--text);
      border-radius: 0;
      min-width: 120px;
    }

    input[type="text"]:focus {
      outline: none;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(126, 167, 166, 0.2);
    }

    button {
      padding: 10px 16px;
      font-size: 15px;
      cursor: pointer;
      margin-left: 2px;
      background: var(--accent);
      color: #fff;
      border: none;
      border-radius: 0;
      box-shadow: none;
      transition: transform 0.1s ease, opacity 0.15s ease;
    }

    button:hover {
      transform: translateY(-1px);
      opacity: 0.95;
    }

    button:active {
      transform: translateY(0);
    }

    .toggle-group {
      display: flex;
      gap: 6px;
      align-items: center;
      flex-wrap: wrap;
    }

    .toggle-group button {
      background: #f2f6f5;
      color: var(--muted);
      border: 1px solid #cfd8d5;
      padding: 9px 12px;
      font-size: 14px;
      transition: background 0.12s ease, color 0.12s ease, border-color 0.12s ease, box-shadow 0.12s ease;
    }

    .toggle-group button.active {
      background: var(--accent);
      color: #fff;
      border-color: var(--accent);
      box-shadow: 0 0 0 3px rgba(126, 167, 166, 0.25);
    }

    .pill-label {
      font-size: 14px;
      color: var(--muted);
      margin-right: 6px;
      display: inline-flex;
      align-items: center;
    }

    .historical-toggle {
      font-size: 14px;
      color: #fff;
      margin-left: 4px;
    }

    .historical-container {
      display: none;
      width: 100%;
      margin-top: 6px;
    }

    .header-bar {
      display: flex;
      align-items: center;
      justify-content: space-between;
      gap: 12px;
      margin-bottom: 12px;
    }

    .help-badge {
      display: inline-flex;
      align-items: center;
      justify-content: center;
      width: 18px;
      height: 18px;
      border-radius: 50%;
      background: var(--accent-soft);
      color: var(--accent);
      font-weight: 600;
      font-size: 12px;
      cursor: default;
      margin-left: 6px;
      border: 1px solid var(--border);
      position: relative;
    }

    .help-badge:hover::after {
      content: attr(data-tip);
      position: absolute;
      top: 120%;
      right: 0;
      background: var(--card);
      color: var(--text);
      border: 1px solid var(--border);
      box-shadow: 0 4px 16px rgba(0, 0, 0, 0.06);
      padding: 8px 10px;
      border-radius: 6px;
      width: 260px;
      font-size: 12px;
      line-height: 1.4;
      z-index: 10;
      white-space: pre-line;
      font-weight: 400;
    }

    #statusText {
      color: var(--muted);
    }

    table {
      border-collapse: collapse;
      width: 100%;
      margin-top: 24px;
      background: #fff;
      border: 1px solid var(--border);
      border-radius: 0;
      overflow: hidden;
      box-shadow: none;
    }

    .table-wrap {
      width: 100%;
      overflow-x: auto;
    }

    th, td {
      border-bottom: 1px solid var(--border);
      padding: 12px 12px;
      text-align: left;
      font-size: 14px;
      vertical-align: top;
    }

    th {
      background: var(--accent-soft);
      color: #3f5150;
      letter-spacing: 0.4px;
      font-size: 13px;
      text-transform: uppercase;
    }

    tr:last-child td {
      border-bottom: none;
    }

    tbody tr:hover {
      background: #f7fbfa;
    }

    a {
      color: var(--accent);
      text-decoration: none;
      font-weight: 600;
    }

    a:hover {
      text-decoration: underline;
    }

    .round_report {
      color: var(--muted);
      line-height: 1.45;
      white-space: normal;
      word-break: break-word;
    }
  </style>
</head>

<body>

  <div class="shell">
    <div class="header-bar">
      <h1 style="margin:0;">go bite win ðŸ¦ˆ</h1>
      <span
        class="help-badge"
        data-tip="You need to be logged in to opencaselist.com for downloading to work (you can log in in a separate tab).
        
        Search text is exact match against team/school/report/tournament."
        aria-label="Troubleshooting"
        role="img"
      >?</span>
    </div>

    <div class="controls" style="gap:12px; flex-wrap:wrap;">
      <input id="searchInput" type="text" placeholder="Search (filename, school, etc.)" />
      <div class="toggle-group" id="sideButtons">
        <span class="pill-label">Side</span>
        <button type="button" data-value="A" class="active">Aff (A)</button>
        <button type="button" data-value="N" class="active">Neg (N)</button>
      </div>
      <label style="font-size:14px; color:var(--muted); display:flex; align-items:center; gap:6px;">
        <input type="checkbox" id="openSourceOnly" />
        Open source only
      </label>
      <div class="toggle-group" id="wikiButtons">
        <span class="pill-label">Wiki</span>
        <button type="button" data-value="hspolicy25" class="active">HS Policy</button>
        <button type="button" data-value="ndtceda25" class="active">NDT/CEDA</button>
        <button type="button" data-value="hsld25" class="active">LD</button>
      </div>
      <button type="button" id="toggleHistoricalBtn" class="historical-toggle">Show historical wikis</button>
    </div>
    <div class="historical-container" id="historicalContainer">
      <div class="toggle-group" id="historicalWikiButtons">
        <span class="pill-label">Historical</span>
        <button type="button" data-value="hspolicy24">HS Policy 24</button>
        <button type="button" data-value="hspolicy23">HS Policy 23</button>
        <button type="button" data-value="hspolicy22">HS Policy 22</button>
        <button type="button" data-value="hspolicy21">HS Policy 21</button>
        <button type="button" data-value="hspolicy20">HS Policy 20</button>
        <button type="button" data-value="ndtceda24">NDT/CEDA 24</button>
        <button type="button" data-value="ndtceda23">NDT/CEDA 23</button>
        <button type="button" data-value="ndtceda22">NDT/CEDA 22</button>
        <button type="button" data-value="ndtceda21">NDT/CEDA 21</button>
        <button type="button" data-value="ndtceda20">NDT/CEDA 20</button>
        <button type="button" data-value="hsld24">LD 24</button>
      </div>
    </div>
    <div class="controls actions" style="gap:12px; flex-wrap:wrap;">
      <button id="searchButton">Search</button>
      <div id="statusText" style="font-size: 14px; display:inline-block;"></div>
      <div id="lastUpdated" style="font-size: 14px; color: var(--muted);"></div>
    </div>

    <div class="table-wrap">
      <table id="resultsTable" style="display:none;">
        <thead>
          <tr>
            <th>Team</th>
            <th>Side</th>
            <th>Wiki</th>
            <th>File</th>
            <th>Open Source Link</th>
            <th>Round Report</th>
          </tr>
        </thead>
        <tbody id="resultsBody"></tbody>
      </table>
    </div>
  </div>

  <script>
    const CACHE_URLS = (shard) => [
      `caches/round_cache_${shard}.json`, // shard-specific in caches/ next to page
      `/caches/round_cache_${shard}.json`, // shard-specific in caches/ at root
      `round_cache_${shard}.json`, // shard-specific next to page
      `round_cache.json`, // default next to page
      `/round_cache_${shard}.json`, // shard-specific at root
      `/round_cache.json`, // default at root
    ];

    const cacheByShard = {};

    function setStatus(text) {
      document.getElementById("statusText").textContent = text || "";
    }

    function setLastUpdated(ts, wikis) {
      const el = document.getElementById("lastUpdated");
      if (!ts) {
        el.textContent = "";
        return;
      }
      const date = new Date(ts * 1000);
      const wikiLabel = wikis && wikis.length ? ` (${wikis.join(", ")})` : "";
      el.textContent = `Last updated: ${date.toLocaleString()}${wikiLabel}`;
    }

    async function loadCacheForShard(shard) {
      if (cacheByShard[shard]) return cacheByShard[shard];
      setStatus(`Loading cached rounds (${shard})â€¦`);

      let lastError = null;
      for (const url of CACHE_URLS(shard)) {
        try {
          const resp = await fetch(url, { cache: "no-cache" });
          if (!resp.ok) throw new Error(`HTTP ${resp.status}`);
          const data = await resp.json();
          const rounds = data.rounds || [];
          cacheByShard[shard] = { rounds, meta: { ...data, shard } };
          setStatus(`Loaded ${rounds.length} rounds (${shard})`);
          return cacheByShard[shard];
        } catch (err) {
          lastError = err;
        }
      }

      setStatus(`Error loading cache: ${lastError ? lastError.message : "unknown"}`);
      throw lastError || new Error("Failed to load cache");
    }

    function filterRounds(query, rounds, { sideFilters, openSourceOnly }) {
      const q = query.toLowerCase();
      return rounds.filter((r) => {
        const report = (r.report || "").toLowerCase();
        const team = (r.team || "").toLowerCase();
        const school = (r.school || "").toLowerCase();
        const tournament = (r.tournament || "").toLowerCase();
        const sideUpper = (r.side || "").toUpperCase();
        const sideOk = !sideFilters.length || sideFilters.includes(sideUpper);
        const hasOpenSource = !!r.file_url;
        const openSourceOk = !openSourceOnly || hasOpenSource;

        const textMatch =
          report.includes(q) ||
          team.includes(q) ||
          school.includes(q) ||
          tournament.includes(q);

        return sideOk && openSourceOk && textMatch;
      });
    }

    function renderResults(items) {
      const table = document.getElementById("resultsTable");
      const body = document.getElementById("resultsBody");
      body.innerHTML = "";

      if (!items.length) {
        table.style.display = "none";
        setStatus("No matches found");
        return;
      }

      items.forEach((item) => {
        const row = document.createElement("tr");
        // Normalize download path for direct API download; if missing, leave as null.
        const downloadPath =
          item.download_path ||
          (item.file_url && item.file_url.replace(/^\/?files\//, "")) ||
          null;
        const linkHref = downloadPath
          ? `https://api.opencaselist.com/v1/download?path=${encodeURIComponent(downloadPath)}`
          : null;

        const teamCell = document.createElement("td");
        teamCell.textContent = item.team || "";
        row.appendChild(teamCell);

        const sideCell = document.createElement("td");
        const side = (item.side || "").toUpperCase();
        sideCell.textContent = side === "A" ? "Aff" : side === "N" ? "Neg" : "";
        row.appendChild(sideCell);

        const wikiCell = document.createElement("td");
        wikiCell.textContent = item.wiki || "";
        row.appendChild(wikiCell);

        const fileCell = document.createElement("td");
        fileCell.textContent = item.tournament || "";
        row.appendChild(fileCell);

        const linkCell = document.createElement("td");
        if (linkHref) {
          const a = document.createElement("a");
          a.href = linkHref;
          a.target = "_blank";
          a.textContent = "Open Source";
          linkCell.appendChild(a);
        } else {
          linkCell.textContent = "N/A";
        }
        row.appendChild(linkCell);

        const snippetCell = document.createElement("td");
        snippetCell.className = "round_report";
        snippetCell.textContent = item.report || "";
        row.appendChild(snippetCell);

        body.appendChild(row);
      });

      table.style.display = "table";
      setStatus(`Found ${items.length} matches`);
    }

    function getSelectedValues(groupId) {
      const buttons = Array.from(document.querySelectorAll(`#${groupId} button`));
      return buttons.filter((btn) => btn.classList.contains("active")).map((btn) => btn.dataset.value);
    }

    function setupToggleGroup(groupId, onChange) {
      const buttons = Array.from(document.querySelectorAll(`#${groupId} button`));
      buttons.forEach((btn) => {
        btn.addEventListener("click", () => {
          btn.classList.toggle("active");
          if (onChange) onChange();
        });
      });
    }

    function maybeAutoSearch() {
      const query = document.getElementById("searchInput").value.trim();
      if (query) {
        performSearch();
      }
    }

    async function performSearch() {
      const query = document.getElementById("searchInput").value.trim();
      const selectedWikis = [
        ...getSelectedValues("wikiButtons"),
        ...getSelectedValues("historicalWikiButtons"),
      ];
      const sideFilters = getSelectedValues("sideButtons").map((s) => s.toUpperCase());
      const openSourceOnly = document.getElementById("openSourceOnly").checked;

      if (!query) {
        setStatus("Enter a search term to begin");
        return;
      }

      if (!selectedWikis.length) {
        setStatus("Select at least one wiki");
        return;
      }

      try {
        const caches = await Promise.all(selectedWikis.map((wiki) => loadCacheForShard(wiki)));
        let allRounds = [];
        caches.forEach((cache, idx) => {
          const wiki = selectedWikis[idx];
          const rounds = cache.rounds || [];
          allRounds = allRounds.concat(rounds.map((r) => ({ ...r, wiki })));
        });

        const latestBuiltAt = caches
          .map((cache) => cache.meta && cache.meta.built_at)
          .filter(Boolean)
          .reduce((max, ts) => Math.max(max, ts), 0);

        const results = filterRounds(query, allRounds, { sideFilters, openSourceOnly });
        renderResults(results);
        setLastUpdated(latestBuiltAt, selectedWikis);
      } catch {
        return; // Status already set in loadCacheOnce
      }
    }

    document.addEventListener("DOMContentLoaded", () => {
      setupToggleGroup("sideButtons", maybeAutoSearch);
      setupToggleGroup("wikiButtons", maybeAutoSearch);
      setupToggleGroup("historicalWikiButtons", maybeAutoSearch);
      document.getElementById("toggleHistoricalBtn").addEventListener("click", () => {
        const container = document.getElementById("historicalContainer");
        const isOpen = container.style.display === "block";
        container.style.display = isOpen ? "none" : "block";
        document.getElementById("toggleHistoricalBtn").textContent = isOpen
          ? "Show historical wikis"
          : "Hide historical wikis";
      });
      document.getElementById("openSourceOnly").addEventListener("change", maybeAutoSearch);
      document.getElementById("searchButton").addEventListener("click", performSearch);
      document
        .getElementById("searchInput")
        .addEventListener("keydown", (evt) => {
          if (evt.key === "Enter") {
            performSearch();
          }
        });
    });
  </script>

</body>
</html>
